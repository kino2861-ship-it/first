<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>レジ入金計算</title>

    <!-- jQuery（CDN） -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <style>
        body { font-family: sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; max-width: 850px; }
        th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
        th { background: #f0f0f0; }
        input[type=number] { width: 70px; text-align: right; font-size: 1em; -moz-appearance: textfield; }
        input[type=number]::-webkit-outer-spin-button, input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        td.auto { background: #fafafa; }
        input.error { background-color: #ffcccc; }
    </style>
</head>

<body>
    <h2>レジ金ふりわけくん</h2>

    <table>
        <thead>
            <tr>
                <th>金種</th>
                <th>総枚数</th>
                <th>棒金本数</th>
                <th>レジ残枚数</th>
                <th>レジ棒本数</th>
                <th>入金枚数</th>
                <th>入金棒本数</th>
            </tr>
        </thead>
        <tbody id="money-table"></tbody>
        <tfoot>
            <tr>
                <th>合計金額</th>
                <td class="auto" id="allSum" colspan="2">0</td>
                <td class="auto" id="regiSum" colspan="2">0</td>
                <td class="auto" id="inSum" colspan="2">0</td>
            </tr>
            <tr>
                <th>レジ金過不足（26万との差）</th>
                <td colspan="6" class="auto" id="gosa">0</td>
            </tr>
        </tfoot>
    </table>

    <script>
        // 明示的に降順にする（確実に逆順表示）
        const yen = [10000, 5000, 2000, 1000, 500, 100, 50, 10, 5, 1];

        const tbody = $("#money-table");

        // 表の生成
        yen.forEach((value, i) => {
            const hasStick = value < 1000; // 棒金欄（コインのみ）
            const row = `
<tr data-index="${i}">
  <th>${value.toLocaleString()}円</th>
  <td><input type="number" class="all" value="0" min="0"></td>
  ${hasStick ? `<td><input type="number" class="allSti" value="0" min="0"></td>` : `<td class="auto">-</td>`}
  <td><input type="number" class="regi" value="0" min="0"></td>
  ${hasStick ? `<td><input type="number" class="regiSti" value="0" min="0"></td>` : `<td class="auto">-</td>`}
  <td class="auto in">0</td>
  <td class="auto inSti">0</td>
</tr>`;
            tbody.append(row);
        });

        // 入力ごとに再計算
        // 入力ごとに再計算（スマホの二重入力対策つき）
$(document).on("input change blur", "input", function () {
    const input = $(this);
    // 少し遅延を置いて確定後に処理（IME重複対策）
    setTimeout(() => {
        let val = input.val();

        // --- 先頭の0を削除（ただし "0" は残す）---
        if (/^0\d+/.test(val)) {
            val = val.replace(/^0+/, "");
            if (val === "") val = "0";
            input.val(val);
        }

        // --- 不正値の修正 ---
        if (Number(val) < 0 || val === "" || isNaN(val)) {
            input.val(0);
        }

        calc();
    }, 50); // ← 50ms程度の遅延がポイント
});


        // Enterキーで「次の行の同じ列」に移動
        $("table").on("keydown", "input", function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                const currentRow = $(this).closest("tr");
                const currentCol = $(this).closest("td").index();
                const nextRow = currentRow.next("tr");
                if (nextRow.length > 0) {
                    const nextInput = nextRow.find("td").eq(currentCol - 1).find("input");
                    if (nextInput.length > 0) nextInput.focus().select();
                }
            }
        });

        // 計算処理（行の<th>から金額を取得する安全な実装）
        function calc() {
            let allSum = 0, regiSum = 0, inSum = 0;

            $("#money-table tr").each(function () {
                // 行の表示テキスト（例 "10,000円"）から数値を取得
                const thText = $(this).find("th").first().text();
                const value = Number(thText.replace(/[,円\s]/g, "")) || 0;

                const all = Number($(this).find(".all").val() || 0);
                const regi = Number($(this).find(".regi").val() || 0);

                const allStiEl = $(this).find(".allSti");
                const regiStiEl = $(this).find(".regiSti");
                const allSti = allStiEl.length ? Number(allStiEl.val() || 0) : 0;
                const regiSti = regiStiEl.length ? Number(regiStiEl.val() || 0) : 0;

                const inVal = all - regi;
                const inSti = allSti - regiSti;

                // エラー表示
                const regiInput = $(this).find(".regi");
                if (regi > all) regiInput.addClass("error"); else regiInput.removeClass("error");

                if (allStiEl.length) {
                    if (regiSti > allSti) regiStiEl.addClass("error"); else regiStiEl.removeClass("error");
                }

                $(this).find(".in").text(inVal);
                $(this).find(".inSti").text(inSti);

                // 合計計算（棒金は50枚分の扱い）
                allSum += all * value + allSti * value * 50;
                regiSum += regi * value + regiSti * value * 50;
                inSum += inVal * value + inSti * value * 50;
            });

            const gosa = regiSum - 260000;

            $("#allSum").text(allSum.toLocaleString());
            $("#regiSum").text(regiSum.toLocaleString());
            $("#inSum").text(inSum.toLocaleString());
            $("#gosa").text(gosa.toLocaleString());
        }

        // 初回計算
        calc();
    </script>
</body>

</html>
