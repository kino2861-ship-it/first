<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>レジ入金計算</title>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 850px;
      margin-bottom: 20px;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }

    th {
      background: #f0f0f0;
    }

    input[type=number] {
      width: 70px;
      text-align: right;
      font-size: 1em;
      -moz-appearance: textfield;
    }

    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    td.auto {
      background: #fafafa;
    }

    input.error {
      background-color: #ffcccc;
    }

    /* スマホ見やすく：テーブル間余白と固定幅 */
    #money-table,
    #in-table {
      font-size: 0.9em;
    }

    h3 {
      margin-top: 30px;
    }
  </style>
</head>

<body>
  <h2>レジ金振り分けくん</h2>

  <!-- 上：メインの計算表 -->
  <table id="main-table">
    <thead>
      <tr>
        <th>金種</th>
        <th>総枚数</th>
        <th>総棒金本数</th>
        <th>レジ残枚数</th>
        <th>レジ残棒本数</th>
      </tr>
    </thead>
    <tbody id="money-table"></tbody>
    <tfoot>
      <tr>
        <th>合計金額</th>
        <td class="auto" id="allSum" colspan="2">0</td>
        <td class="auto" id="regiSum" colspan="2">0</td>
      </tr>
      <tr>
        <th>レジ金過不足（26万との差）
        </th>
        <td colspan="4" class="auto" id="gosa">0</td>
      </tr>
    </tfoot>
  </table>

  <!-- 下：入金情報だけの表 -->
  <h3>入金内訳</h3>
  <table id="in-table">
    <thead>
      <tr>
        <th>金種</th>
        <th>入金枚数</th>
        <th>入金棒本数</th>
      </tr>
    </thead>
    <tbody id="in-body"></tbody>
    <tfoot>
      <tr>
        <th>入金合計</th>
        <td class="auto" id="inSum" colspan="2">0</td>
      </tr>
    </tfoot>
  </table>

  <script>
    const yen = [1, 5, 10, 50, 100, 500, 1000, 2000, 5000, 10000];
    const tbody = $("#money-table");
    const inBody = $("#in-body");

    // 表の生成
    // ▼これに置き換え
yen.slice().reverse().forEach((value, i) => {
  const originalIndex = yen.length - 1 - i;  // ← 元配列のインデックスを保持
  const hasStick = value < 1000;

  const row = `
<tr data-index="${originalIndex}">
  <th>${value.toLocaleString()}円</th>
  <td><input type="number" inputmode="numeric" class="all" value="0" min="0"></td>
  ${hasStick ? `<td><input type="number" inputmode="numeric" class="allSti" value="0" min="0"></td>` : `<td class="auto">-</td>`}
  <td><input type="number" inputmode="numeric" class="regi" value="0" min="0"></td>
  ${hasStick ? `<td><input type="number" inputmode="numeric" class="regiSti" value="0" min="0"></td>` : `<td class="auto">-</td>`}
</tr>`;
  tbody.append(row);

  const inRow = `
<tr data-index="${originalIndex}">
  <th>${value.toLocaleString()}円</th>
  <td class="auto in">0</td>
  <td class="auto inSti">0</td>
</tr>`;
  inBody.append(inRow);
});


    // 入力ごとに再計算
    $("input").on("input", function () {
      if (Number($(this).val()) < 0 || $(this).val() === "") {
        $(this).val(0);
      }
      calc();
    });

    // Enterキーで「次の行の同じ列」に移動
    $("table").on("keydown", "input", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();

        const currentRow = $(this).closest("tr");
        const currentCol = $(this).closest("td").index();
        const nextRow = currentRow.next("tr");

        if (nextRow.length > 0) {
          const nextInput = nextRow.find("td").eq(currentCol - 1).find("input");
          if (nextInput.length > 0) {
            nextInput.focus().select();
          }
        }
      }
    });

    // 計算処理
    function calc() {
      let allSum = 0, regiSum = 0, inSum = 0;

      $("#money-table tr").each(function () {
        const i = $(this).data("index");
        const value = yen[i];

        const all = Number($(this).find(".all").val());
        const regi = Number($(this).find(".regi").val());
        const allSti = value < 1000 ? Number($(this).find(".allSti").val()) : 0;
        const regiSti = value < 1000 ? Number($(this).find(".regiSti").val()) : 0;

        const inVal = all - regi;
        const inSti = allSti - regiSti;

        // エラー表示
        const regiInput = $(this).find(".regi");
        const regiStiInput = $(this).find(".regiSti");
        if (regi > all) regiInput.addClass("error");
        else regiInput.removeClass("error");

        if (value < 1000) {
          if (regiSti > allSti) regiStiInput.addClass("error");
          else regiStiInput.removeClass("error");
        }

        // 入金表示を別テーブルへ反映
        $("#in-body tr").eq(i).find(".in").text(inVal);
        $("#in-body tr").eq(i).find(".inSti").text(inSti);

        // 合計計算
        allSum += all * value + allSti * value * 50;
        regiSum += regi * value + regiSti * value * 50;
        inSum += inVal * value + inSti * value * 50;
      });

      const gosa = regiSum - 260000;

      $("#allSum").text(allSum.toLocaleString());
      $("#regiSum").text(regiSum.toLocaleString());
      $("#inSum").text(inSum.toLocaleString());
      $("#gosa").text(gosa.toLocaleString());
    }

    calc();
  </script>

</body>

</html>
